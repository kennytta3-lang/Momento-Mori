<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memento Mori Widget</title>
    <style>
        :root {
            --bg-color: #191919; /* Matches Notion Dark Mode */
            --text-color: #e0e0e0;
            --box-empty: #2f2f2f;
            --box-filled: #e0e0e0;
            --box-current: #ff5252;
            --accent: #4a90e2;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 { font-size: 1.2rem; margin-bottom: 5px; font-weight: normal; letter-spacing: 2px; }
        p { font-size: 0.8rem; color: #666; margin-bottom: 20px; }

        /* Controls */
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.8rem;
        }

        input[type="date"] {
            padding: 5px;
            background: #2f2f2f;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 4px;
            font-family: inherit;
        }

        button {
            padding: 6px 12px;
            background-color: #333;
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75rem;
            transition: background 0.2s;
        }

        button:hover { background-color: #444; }
        button.primary { background-color: var(--accent); border-color: var(--accent); }

        /* The Grid */
        .life-grid {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            max-width: 720px; 
            gap: 3px;
            justify-content: flex-start;
        }

        .week-box {
            width: 6px;
            height: 6px;
            background-color: var(--box-empty);
            border-radius: 1px;
        }

        .week-box.filled { background-color: var(--box-filled); }
        
        .week-box.current { 
            background-color: var(--box-current); 
            box-shadow: 0 0 4px var(--box-current);
        }

        .stats {
            margin-top: 20px;
            font-size: 0.75rem;
            color: #555;
            text-align: center;
            line-height: 1.4;
        }
    </style>
</head>
<body>

    <h1>MEMENTO MORI</h1>
    <div id="subtitle-container">
        <p>Target: 80 Years</p>
    </div>

    <div class="controls" id="setup-panel">
        <label>Birth Date: </label>
        <input type="date" id="birthdate-input">
        <button class="primary" onclick="saveDate()">Start</button>
    </div>

    <div class="controls" id="action-panel" style="display:none;">
        <button class="primary" onclick="markWeekDone()">Mark Week Done</button>
        <button onclick="resetData()">Reset</button>
    </div>

    <div class="life-grid" id="grid"></div>
    <div class="stats" id="stats-display"></div>

    <script>
        const TARGET_AGE = 80;
        const gridContainer = document.getElementById('grid');
        const setupPanel = document.getElementById('setup-panel');
        const actionPanel = document.getElementById('action-panel');
        const statsDisplay = document.getElementById('stats-display');
        const subtitle = document.getElementById('subtitle-container');

        window.onload = function() {
            const savedDob = localStorage.getItem('memento_dob');
            if (savedDob) {
                renderCalendar(savedDob);
            }
        };

        function saveDate() {
            const dob = document.getElementById('birthdate-input').value;
            if (!dob) return alert("Please enter a valid date.");
            localStorage.setItem('memento_dob', dob);
            renderCalendar(dob);
        }

        function resetData() {
            if(confirm("Reset date?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function renderCalendar(dobString) {
            setupPanel.style.display = 'none';
            actionPanel.style.display = 'flex';
            
            const dob = new Date(dobString + "T00:00:00"); // Fix timezone issues
            const today = new Date();
            
            // Calculate EXACT 80th Birthday
            const deathDate = new Date(dob);
            deathDate.setFullYear(dob.getFullYear() + TARGET_AGE);

            // Calculate precise week counts
            const oneWeek = 1000 * 60 * 60 * 24 * 7;
            const totalLifeTime = deathDate - dob;
            const timeLived = today - dob;

            // Total weeks in exactly 80 years (approx 4174 due to leap years)
            const totalWeeks = Math.floor(totalLifeTime / oneWeek);
            const weeksLived = Math.floor(timeLived / oneWeek);
            
            const percentage = ((weeksLived / totalWeeks) * 100).toFixed(2);

            // Update Text
            subtitle.innerHTML = `<p>${dob.toDateString()} â€” ${deathDate.toDateString()}</p>`;

            // Render Grid
            gridContainer.innerHTML = '';
            
            // Fragment for performance
            const fragment = document.createDocumentFragment();

            for (let i = 0; i < totalWeeks; i++) {
                const box = document.createElement('div');
                box.className = 'week-box';

                if (i < weeksLived) {
                    box.classList.add('filled');
                } else if (i === weeksLived) {
                    box.classList.add('current');
                }
                
                fragment.appendChild(box);
            }
            gridContainer.appendChild(fragment);

            statsDisplay.innerHTML = `
                ${weeksLived.toLocaleString()} weeks lived<br>
                ${(totalWeeks - weeksLived).toLocaleString()} weeks remaining<br>
                ${percentage}% complete
            `;
        }

        function markWeekDone() {
            alert("Week marked complete.");
            location.reload(); 
        }
    </script>
</body>
</html>
